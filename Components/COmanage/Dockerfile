FROM tier/comanage:3.2.2-20190503-rc1


ENV COMANAGE_REGISTRY_ADMIN_FAMILY_NAME=Lastname
ENV COMANAGE_REGISTRY_ADMIN_USERNAME=somebody@example.org
ENV COMANAGE_REGISTRY_DATASOURCE=Database/Mysql
ENV COMANAGE_REGISTRY_DATABASE=registry
ENV COMANAGE_REGISTRY_DATABASE_HOST=mysql.example.org
ENV COMANAGE_REGISTRY_DATABASE_USER=registry_user
ENV COMANAGE_REGISTRY_DATABASE_USER_PASSWORD=SomeSecretPassword
ENV COMANAGE_REGISTRY_EMAIL_FROM=comanage@example.org
ENV COMANAGE_REGISTRY_EMAIL_TRANSPORT=Smtp
ENV COMANAGE_REGISTRY_EMAIL_PORT=25
ENV COMANAGE_REGISTRY_EMAIL_HOST=smtp.example.org
# COMANAGE_REGISTRY_SECURITY_SALT - autogenerated if not specified
# COMANAGE_REGISTRY_SECURITY_SEED - autogenerated if not specified
ENV HTTPS_CERT_FILE=/etc/pki/tls/certs/localhost.crt
ENV HTTPS_KEY_FILE=/etc/pki/tls/private/localhost.key
ENV SERVER_NAME=comanage.example.org
ENV MYSQL_ROOT_PASSWORD=SomeReallySuperSecretPassword
ENV MYSQL_DATABASE=registry
ENV MYSQL_USER=registry_user
ENV MYSQL_PASSWORD_FILE=SuperSecretPassword
#ENV SHIBBOLETH_SP_CERT=/etc/shibboleth/sp-cert.pem
#ENV SHIBBOLETH_SP_PRIVKEY=/etc/shibboleth/sp-key.pem
ENV SHIBBOLETH_SP_ENTITY_ID=comanage.example.org
#ENV SHIBBOLETH_SP_METADATA_PROVIDER_XML=<something>
#ENV SHIBBOLETH_SP_SAMLDS_URL=https://someds


RUN yum -y update && yum -y install --setopt=tsflags=nodocs epel-release python-pip && pip install --upgrade pip

ARG maintainer=my
ARG imagename=comanage
ARG version=3.2.2

LABEL Version=$version
ENV VERSION=$version

COPY 000-comanage.conf /etc/httpd/conf.d/

COPY container_files/shibboleth/sp-cert.pem /etc/shibboleth
COPY container_files/shibboleth/sp-key.pem /etc/shibboleth
RUN chown shibd:shibd /etc/shibboleth/sp-key.pem && \
    chown shibd:shibd /etc/shibboleth/sp-cert.pem 

COPY container_files/shibboleth2.xml /etc/shibboleth/shibboleth2.xml
COPY container_files/attribute-map.xml /etc/shibboleth/attribute-map.xml

ADD container_files/some-metadata_signing_cert.crt /etc/pki/tls/certs/

VOLUME /etc/httpd/logs
ENV LD_LIBRARY_PATH=/opt/shibboleth/lib64


