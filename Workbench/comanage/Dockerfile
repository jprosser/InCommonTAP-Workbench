FROM i2incommon/comanage-registry:4.3.2-20231211
#FROM i2incommon/comanage-registry:4.1.0-20230117

ENV COMANAGE_REGISTRY_ADMIN_FAMILY_NAME=Anderson
ENV COMANAGE_REGISTRY_ADMIN_USERNAME=banderson
ENV COMANAGE_REGISTRY_DATASOURCE=Database/Postgres
ENV COMANAGE_REGISTRY_DATABASE=registry
ENV COMANAGE_REGISTRY_DATABASE_HOST=comanage-data
ENV COMANAGE_REGISTRY_DATABASE_PORT=5432
ENV COMANAGE_REGISTRY_DATABASE_USER=registry_user
ENV COMANAGE_REGISTRY_DATABASE_USER_PASSWORD=Password1
ENV COMANAGE_REGISTRY_EMAIL_FROM=noreply@workbench.incommon.org
ENV COMANAGE_REGISTRY_EMAIL_TRANSPORT=Smtp
ENV COMANAGE_REGISTRY_EMAIL_PORT=465
ENV COMANAGE_REGISTRY_EMAIL_HOST=tls://email-smtp.us-west-2.amazonaws.com
ENV COMANAGE_REGISTRY_EMAIL_ACCOUNT=AKIAZDWJANQRZKPFVK6J
ENV COMANAGE_REGISTRY_EMAIL_ACCOUNT_PASSWORD=BNAp6WlvsI4iXK3ush8pwPD2QKHDYQ09ti+Z3r/mb2Nx

#ENV HTTPS_CERT_FILE=/etc/pki/tls/certs/localhost.crt
#ENV HTTPS_PRIVKEY_FILE=/etc/pki/tls/private/localhost.key
# COMANAGE_REGISTRY_SECURITY_SALT - autogenerated if not specified
# COMANAGE_REGISTRY_SECURITY_SEED - autogenerated if not specified
#ENV SHIBBOLETH_SP_CERT=/etc/shibboleth/sp-cert.pem
#ENV SHIBBOLETH_SP_PRIVKEY=/etc/shibboleth/sp-key.pem
#ENV SHIBBOLETH_SP_ENTITY_ID=comanage.example.edu
#ENV SHIBBOLETH_SP_METADATA_PROVIDER_XML=sdf
#ENV SHIBBOLETH_SP_SAMLDS_URL=thing

#temp - override upstream shib SP repo
COPY container_files/shibboleth/shibboleth.repo /etc/yum.repos.d/security:shibboleth.repo

RUN yum -y update && yum -y install --setopt=tsflags=nodocs epel-release python-pip && pip install awscli && pip install --upgrade pip

ARG maintainer=my
ARG imagename=comanage
ARG version=4.3.2
ARG CSPHOSTNAME=localhost
ENV CSPHOSTNAME=$CSPHOSTNAME
ENV COMANAGE_REGISTRY_VIRTUAL_HOST_FQDN=$CSPHOSTNAME

LABEL Version=$version
ENV VERSION=$version

COPY container_files/shibboleth/* /etc/shibboleth/

# activate SQL plugin
RUN mkdir -p /srv/comanage-registry/local/Plugin/
RUN ln -s /srv/comanage-registry/app/AvailablePlugin/SqlProvisioner /srv/comanage-registry/local/Plugin/

COPY container_files/httpd/ /etc/httpd/conf.d/

COPY container_files/system/setservername.sh /usr/local/bin/
RUN chmod 755 /usr/local/bin/setservername.sh && rm -f /etc/httpd/conf.d/ssl.conf

#set hostname
RUN /usr/local/bin/setservername.sh

ENV LD_LIBRARY_PATH=/opt/shibboleth/lib64
